<script>
    function sendReservation()
    {
        let nameInput = $("input[name='name']");
        let surnameInput = $("input[name='surname']");
        let emailInput = $("input[name='emailAddress']");
        
        if(nameInput.is(":invalid"))
        {
            // nameInput.attr("placeholder", "");
            showNotification("Položka 'Meno' je povinná! Prosím, vyplnte položku 'Meno'.", "warning", "error");
            return;
        }
        
        if(surnameInput.is(":invalid"))
        {
            // surnameInput.attr("placeholder", "");
            showNotification("Položka 'Priezvisko' je povinná! Prosím, vyplnte položku 'Priezvisko'.", "warning", "error");
            return;
        }
        
        if(emailInput.is(":invalid"))
        {
            showNotification("Zadaná e-mailova adresa je nesprávna! Prosím, zadajte spravnu e-mailovú adresu.", "warning", "error");
            return;
        }
        
        let chosenSessions = "";
        
        $("input[type='checkbox']:checked").each(
            function (index)
            {
                if(index > 0) chosenSessions += ", ";
                chosenSessions += ($(this).attr("name") + " " + $(this).val());
            }
        );
        
        if(chosenSessions.length == 0)
        {
            showNotification("Prosím, vyberte si aspoň jeden termín.", "warning", "error");
            return;
        }
        
        let reservation = 
        {
            timestamp: getTimestamp(),
            name : nameInput.val(),
            surname : surnameInput.val(),
            email : emailInput.val(),
            sessions : chosenSessions
        }
        
        renderLoadingScreen();
        
        google.script.run
        .withFailureHandler(
            (error) =>
            {
                deleteLoadingScreen();
                let errorMessage = error.message.slice(7);
                let response = JSON.parse(errorMessage);
                
                console.log(response);
                
                renderReservationError(response);
            }
        )
        .withSuccessHandler(
            (response) =>
            {
                deleteLoadingScreen();
                
                let reservation = JSON.parse(response);
                renderReservationSuccess(reservation);
            }
        )
        .onHtmlFormSubmit(reservation);
    }
    
    function refreshForm()
    {
        renderLoadingScreen();
        
        let nameInputSelector = "input[name='name']";
        let surnameInputSelector = "input[name='surname']";
        let emailInputSelector = "input[name='emailAddress']";
        
        let formData = 
        {
            name : $(nameInputSelector).val(),
            surname : $(surnameInputSelector).val(),
            email : $(emailInputSelector).val(),
        }
        
        google.script.run
        .withFailureHandler(
            (error) =>
            {
                
            }
        )
        .withSuccessHandler(
            (html) =>
            {
                $("#form").replaceWith(html);
                $(nameInputSelector).val(formData.name);
                $(surnameInputSelector).val(formData.surname);
                $(emailInputSelector).val(formData.email);
                
                deleteLoadingScreen();
            }
        )
        .getReservationFormHtml();
    }
    
    function getTimestamp()
    {
        let now = new Date();
        
        let date = now.getDate();
        let month = now.getMonth() + 1;
        let year = now.getFullYear();
        
        let hours = now.getHours();
        let minutes = now.getMinutes();
        let seconds = now.getSeconds();
        
        let timestamp =`${date}.${month}.${year} ${hours}:${minutes}:${seconds}`;
        
        return timestamp;
    }
    
    $("#sendButton").on("click", sendReservation);
    
    $('input[type="checkbox"]').on(
        "change", 
        function() 
        {
            $('input[name="' + this.name + '"]').not(this).prop('checked', false);
        }
    );
</script>